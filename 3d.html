<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8>
		<title>My first Three.js app</title>
		<style>
			body { margin: 0; }
			canvas {
        width: 90%;
        height: 90%
      }
		</style>
		<script src="js/three.js"></script>
		<script src="js/FirstPersonControls.js"></script>
    <script src='js/threex.text.js'></script>
		<script src="js/algorithm.js"></script>
		<script src="js/columns_model.js"></script>
	</head>
	<body>

	<script>
		/* 3D */
		function init_columns(numColumns, begin, orientation) {
//			var columnsModel = ColumnsModel([-numColumns, -300], [2, 1]);
			var columnsModel = ColumnsModel(begin, orientation);
			for(var i = 0; i < numColumns; i++) {
				columnsModel.create_column(Math.floor(Math.random() * (100)) + 1);
			}
			return columnsModel;
		}

		function add_all_to(scene, columns) {
			for(var i in columns) {
				scene.add(columns[i]);
			}
		}

		/* Start */
		var controls;
		var scene;
		var camera;
		var renderer;

		scene = new THREE.Scene();
		camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );
		renderer = new THREE.WebGLRenderer();
		renderer.setSize( window.innerWidth, window.innerHeight );

		document.body.appendChild( renderer.domElement );
//    var hintText = THREE.TextGeometry('Press V to Interact with W A S D and Mouse');
//    var hintText = new THREEx.Text('Press V to Interact with W A S D and Mouse');
//    hintText.setPosition(new Vector3(0, 500, -300));
//    scene.add(hintText);

		// models
		var columnsModel1 = init_columns(250, [-250, -300], [2, 0]);
		var columnsModel2 = init_columns(250, [-250, -300], [0, 2]);
		var columnsModel3 = init_columns(250, [-250, 200], [2, 0]);
		var columnsModel4 = init_columns(250, [250, 200], [0, -2]);
		add_all_to(scene, columnsModel1.columns);
		add_all_to(scene, columnsModel2.columns);
		add_all_to(scene, columnsModel3.columns);
		add_all_to(scene, columnsModel4.columns);


		var quickSortGenerator1 = Algorithm.quick_sort(columnsModel1.columns, 0, columnsModel1.columns.length-1, swap, smaller_than);
		var quickSortGenerator2 = Algorithm.quick_sort(columnsModel2.columns, 0, columnsModel2.columns.length-1, swap, larger_than);
		var quickSortGenerator3 = Algorithm.quick_sort(columnsModel3.columns, 0, columnsModel3.columns.length-1, swap, smaller_than);
		var quickSortGenerator4 = Algorithm.quick_sort(columnsModel4.columns, 0, columnsModel4.columns.length-1, swap, larger_than);
		// var mergeSortGenerator = Algorithm.merge_sort(columnsModel.columns, move_to, smaller_than);

		// key, user interaction
		document.onkeypress = function(evt) {
			evt = evt || window.event;
			var charCode = evt.keyCode || evt.which;
			var charStr = String.fromCharCode(charCode);
			console.log(charStr);
			switch(charStr) {
				case 'v':
          //todo: if the browser support
          var element = document.body;
          element.requestPointerLock = element.requestPointerLock || element.mozRequestPointerLock || element.webkitRequestPointerLock;
          element.requestPointerLock();
          controls.enabled = true;
					break;
			}
		};

		THREE.FirstPersonControls(camera);
		controls = new THREE.FirstPersonControls( camera );
		controls.movementSpeed = 200;
		controls.lookSpeed = 100;
		controls.noFly = true;
		controls.lookVertical = true;
    controls.enabled = false;

		var clock = new THREE.Clock();
		(function render() {
			requestAnimationFrame( render );
			renderer.render( scene, camera );
			quickSortGenerator1.next();
			quickSortGenerator2.next();
			quickSortGenerator3.next();
			quickSortGenerator4.next();
			columnsModel1.justify_position();
			columnsModel2.justify_position();
			columnsModel3.justify_position();
			columnsModel4.justify_position();
			controls.update( clock.getDelta());
		})();

		window.addEventListener('devicemotion', function(event) {
//			console.log(event.acceleration.x + ' m/s2');
//			var z = event.rotationRate.alpha;
//			var x = event.rotationRate.beta;
//			var y = event.rotationRate.gamma;

			var x = Math.cos(event.rotationRate.gamma);
			var y = Math.sin(event.rotationRate.beta);
			var z = -Math.sin(event.rotationRate.gamma) - Math.cos(event.rotationRate.beta);
			console.log(x, y, z);
			camera.lookAt( new THREE.Vector3( x, y, z ) )
		});

    // Ask the browser to lock the pointer
	</script>
	</body>
</html>
